function p(e,o){let t=L.map(e,{maxZoom:18,center:[35.943,136.188]});L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19}).addTo(t),t.markerLayer=L.layerGroup(),t.markerLayer.addTo(t),t.addInfoBox=function(r){let c=[[r.lat1,r.lng1],[r.lat2,r.lng2]],s=L.rectangle(c,{color:"#0033ff",weight:2,fillOpacity:.1}),i=`
			<div class="info-box">
				<h3>\u6295\u7A3F\u8005: ${r.posterName}</h3>
				<p><strong>\u5E74\u4EE3:</strong> ${r.era}</p>
				<p>${r.bodyText.replace(/\n/g,"<br>")}</p>
			</div>
		`;return s.bindTooltip(i,{permanent:!0,direction:"center",className:"info-tooltip"}),this.markerLayer.addLayer(s),s};let a=new L.FeatureGroup;t.addLayer(a);let l=new L.Control.Draw({edit:{featureGroup:a},draw:{polygon:!1,polyline:!1,circle:!1,marker:!1,circlemarker:!1,rectangle:{shapeOptions:{color:"#007bff"}}}});return t.addControl(l),t.on(L.Draw.Event.CREATED,async r=>{let c=r;if(c.layerType==="rectangle"){let s=c.layer;a.addLayer(s);let i=s.getBounds();await o(i)||a.removeLayer(s)}}),t}var d=[],y=document.getElementById("infoModal"),m=document.getElementById("submitInfo"),f=document.getElementById("cancelInfo"),g=document.getElementById("posterName"),h=document.getElementById("era"),w=document.getElementById("bodyText"),I=document.getElementById("map-bounds-display"),v=15;function b(){let e=n.getBounds(),o=e.getSouthWest(),t=e.getNorthEast(),a=o.lat.toFixed(4),l=o.lng.toFixed(4),r=t.lat.toFixed(4),c=t.lng.toFixed(4);I.innerHTML=`
    SW: (${a}, ${l})<br>
    NE: (${r}, ${c})
  `}function u(){n.getZoom()<v?n.hasLayer(n.markerLayer)&&n.removeLayer(n.markerLayer):n.hasLayer(n.markerLayer)||n.addLayer(n.markerLayer)}async function k(){try{let e=await fetch("/api/load-data");if(!e.ok)throw new Error(`\u30B5\u30FC\u30D0\u30FC\u30A8\u30E9\u30FC: ${e.status}`);let o=await e.json();Array.isArray(o)&&(d=o,E(),u(),console.log("\u30C7\u30FC\u30BF\u8AAD\u307F\u8FBC\u307F\u6210\u529F"))}catch(e){console.error("\u8AAD\u307F\u8FBC\u307F\u5931\u6557:",e)}}function E(){n.markerLayer.clearLayers(),d.forEach(e=>{e.bounds&&e.info&&n.addInfoBox({lat1:e.bounds.lat1,lng1:e.bounds.lng1,lat2:e.bounds.lat2,lng2:e.bounds.lng2,...e.info})})}function x(){return g.value="",h.value="",w.value="",y.style.display="block",new Promise(e=>{let o=()=>{a(),e({posterName:g.value,era:h.value,bodyText:w.value})},t=()=>{a(),e(null)},a=()=>{y.style.display="none",m.removeEventListener("click",o),f.removeEventListener("click",t)};m.addEventListener("click",o,{once:!0}),f.addEventListener("click",t,{once:!0})})}async function B(e){let o=await x();if(o){let t=e.getSouthWest(),a=e.getNorthEast();return d.push({bounds:{lat1:t.lat,lng1:t.lng,lat2:a.lat,lng2:a.lng},info:o}),E(),u(),!0}return!1}var n=p("map",B);n.setView([35.943,136.188],15);n.on("moveend",b);n.on("zoomend",u);k();b();
